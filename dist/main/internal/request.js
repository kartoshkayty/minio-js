"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.request = request;
exports.requestWithRetry = requestWithRetry;
var _stream = require("stream");
var _util = require("util");
const pipelineAsync = (0, _util.promisify)(_stream.pipeline);
async function request(transport, opt, body = null) {
  return new Promise((resolve, reject) => {
    const requestObj = transport.request(opt, response => {
      resolve(response);
    });
    requestObj.on('error', reject);
    if (!body || Buffer.isBuffer(body) || typeof body === 'string') {
      requestObj.end(body);
    } else {
      pipelineAsync(body, requestObj).catch(reject);
    }
  });
}
const MAX_RETRIES = 2;
const EXP_BACK_OFF_BASE_DELAY = 1000; // Base delay for exponential backoff
const ADDITIONAL_DELAY_FACTOR = 1.0; // to avoid synchronized retries

// Retryable error codes for HTTP ( ref: minio-go)
const retryHttpCodes = exports.retryHttpCodes = {
  408: true,
  429: true,
  499: true,
  500: true,
  502: true,
  503: true,
  504: true,
  520: true
};
const isHttpRetryable = httpResCode => {
  return retryHttpCodes[httpResCode] !== undefined;
};
const sleep = ms => {
  return new Promise(resolve => setTimeout(resolve, ms));
};
const getExpBackOffDelay = retryCount => {
  const backOffBy = EXP_BACK_OFF_BASE_DELAY * 2 ** retryCount;
  const additionalDelay = Math.random() * backOffBy * ADDITIONAL_DELAY_FACTOR;
  return backOffBy + additionalDelay;
};
async function requestWithRetry(transport, opt, body = null, maxRetries = MAX_RETRIES) {
  let attempt = 0;
  let isRetryable = false;
  while (attempt <= maxRetries) {
    try {
      const response = await request(transport, opt, body);
      // Check if the HTTP status code is retryable
      if (isHttpRetryable(response.statusCode)) {
        isRetryable = true;
        throw new Error(`Retryable HTTP status: ${response.statusCode}`); // trigger retry attempt with calculated delay
      }
      return response; // Success, return the raw response
    } catch (err) {
      if (isRetryable) {
        attempt++;
        isRetryable = false;
        if (attempt > maxRetries) {
          throw new Error(`Request failed after ${maxRetries} retries: ${err}`);
        }
        const delay = getExpBackOffDelay(attempt);
        // eslint-disable-next-line no-console
        console.warn(`${new Date().toLocaleString()} Retrying request (attempt ${attempt}/${maxRetries}) after ${delay}ms due to: ${err}`);
        await sleep(delay);
      } else {
        throw err; // re-throw if any request, syntax errors
      }
    }
  }
  throw new Error(`${MAX_RETRIES} Retries exhausted, request failed.`);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfc3RyZWFtIiwicmVxdWlyZSIsIl91dGlsIiwicGlwZWxpbmVBc3luYyIsInByb21pc2lmeSIsInBpcGVsaW5lIiwicmVxdWVzdCIsInRyYW5zcG9ydCIsIm9wdCIsImJvZHkiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsInJlcXVlc3RPYmoiLCJyZXNwb25zZSIsIm9uIiwiQnVmZmVyIiwiaXNCdWZmZXIiLCJlbmQiLCJjYXRjaCIsIk1BWF9SRVRSSUVTIiwiRVhQX0JBQ0tfT0ZGX0JBU0VfREVMQVkiLCJBRERJVElPTkFMX0RFTEFZX0ZBQ1RPUiIsInJldHJ5SHR0cENvZGVzIiwiZXhwb3J0cyIsImlzSHR0cFJldHJ5YWJsZSIsImh0dHBSZXNDb2RlIiwidW5kZWZpbmVkIiwic2xlZXAiLCJtcyIsInNldFRpbWVvdXQiLCJnZXRFeHBCYWNrT2ZmRGVsYXkiLCJyZXRyeUNvdW50IiwiYmFja09mZkJ5IiwiYWRkaXRpb25hbERlbGF5IiwiTWF0aCIsInJhbmRvbSIsInJlcXVlc3RXaXRoUmV0cnkiLCJtYXhSZXRyaWVzIiwiYXR0ZW1wdCIsImlzUmV0cnlhYmxlIiwic3RhdHVzQ29kZSIsIkVycm9yIiwiZXJyIiwiZGVsYXkiLCJjb25zb2xlIiwid2FybiIsIkRhdGUiLCJ0b0xvY2FsZVN0cmluZyJdLCJzb3VyY2VzIjpbInJlcXVlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgKiBhcyBodHRwIGZyb20gJ25vZGU6aHR0cCdcclxuaW1wb3J0IHR5cGUgKiBhcyBodHRwcyBmcm9tICdub2RlOmh0dHBzJ1xyXG5pbXBvcnQgdHlwZSAqIGFzIHN0cmVhbSBmcm9tICdub2RlOnN0cmVhbSdcclxuaW1wb3J0IHsgcGlwZWxpbmUgfSBmcm9tICdub2RlOnN0cmVhbSdcclxuaW1wb3J0IHsgcHJvbWlzaWZ5IH0gZnJvbSAnbm9kZTp1dGlsJ1xyXG5cclxuaW1wb3J0IHR5cGUgeyBUcmFuc3BvcnQgfSBmcm9tICcuL3R5cGUudHMnXHJcblxyXG5jb25zdCBwaXBlbGluZUFzeW5jID0gcHJvbWlzaWZ5KHBpcGVsaW5lKVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlcXVlc3QoXHJcbiAgdHJhbnNwb3J0OiBUcmFuc3BvcnQsXHJcbiAgb3B0OiBodHRwcy5SZXF1ZXN0T3B0aW9ucyxcclxuICBib2R5OiBCdWZmZXIgfCBzdHJpbmcgfCBzdHJlYW0uUmVhZGFibGUgfCBudWxsID0gbnVsbCxcclxuKTogUHJvbWlzZTxodHRwLkluY29taW5nTWVzc2FnZT4ge1xyXG4gIHJldHVybiBuZXcgUHJvbWlzZTxodHRwLkluY29taW5nTWVzc2FnZT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgY29uc3QgcmVxdWVzdE9iaiA9IHRyYW5zcG9ydC5yZXF1ZXN0KG9wdCwgKHJlc3BvbnNlKSA9PiB7XHJcbiAgICAgIHJlc29sdmUocmVzcG9uc2UpXHJcbiAgICB9KVxyXG5cclxuICAgIHJlcXVlc3RPYmoub24oJ2Vycm9yJywgcmVqZWN0KVxyXG5cclxuICAgIGlmICghYm9keSB8fCBCdWZmZXIuaXNCdWZmZXIoYm9keSkgfHwgdHlwZW9mIGJvZHkgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgIHJlcXVlc3RPYmouZW5kKGJvZHkpXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBwaXBlbGluZUFzeW5jKGJvZHksIHJlcXVlc3RPYmopLmNhdGNoKHJlamVjdClcclxuICAgIH1cclxuICB9KVxyXG59XHJcblxyXG5jb25zdCBNQVhfUkVUUklFUyA9IDJcclxuY29uc3QgRVhQX0JBQ0tfT0ZGX0JBU0VfREVMQVkgPSAxMDAwIC8vIEJhc2UgZGVsYXkgZm9yIGV4cG9uZW50aWFsIGJhY2tvZmZcclxuY29uc3QgQURESVRJT05BTF9ERUxBWV9GQUNUT1IgPSAxLjAgLy8gdG8gYXZvaWQgc3luY2hyb25pemVkIHJldHJpZXNcclxuXHJcbi8vIFJldHJ5YWJsZSBlcnJvciBjb2RlcyBmb3IgSFRUUCAoIHJlZjogbWluaW8tZ28pXHJcbmV4cG9ydCBjb25zdCByZXRyeUh0dHBDb2RlczogUmVjb3JkPHN0cmluZywgYm9vbGVhbj4gPSB7XHJcbiAgNDA4OiB0cnVlLFxyXG4gIDQyOTogdHJ1ZSxcclxuICA0OTk6IHRydWUsXHJcbiAgNTAwOiB0cnVlLFxyXG4gIDUwMjogdHJ1ZSxcclxuICA1MDM6IHRydWUsXHJcbiAgNTA0OiB0cnVlLFxyXG4gIDUyMDogdHJ1ZSxcclxufVxyXG5cclxuY29uc3QgaXNIdHRwUmV0cnlhYmxlID0gKGh0dHBSZXNDb2RlOiBudW1iZXIpID0+IHtcclxuICByZXR1cm4gcmV0cnlIdHRwQ29kZXNbaHR0cFJlc0NvZGVdICE9PSB1bmRlZmluZWRcclxufVxyXG5cclxuY29uc3Qgc2xlZXAgPSAobXM6IG51bWJlcikgPT4ge1xyXG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gc2V0VGltZW91dChyZXNvbHZlLCBtcykpXHJcbn1cclxuXHJcbmNvbnN0IGdldEV4cEJhY2tPZmZEZWxheSA9IChyZXRyeUNvdW50OiBudW1iZXIpID0+IHtcclxuICBjb25zdCBiYWNrT2ZmQnkgPSBFWFBfQkFDS19PRkZfQkFTRV9ERUxBWSAqIDIgKiogcmV0cnlDb3VudFxyXG4gIGNvbnN0IGFkZGl0aW9uYWxEZWxheSA9IE1hdGgucmFuZG9tKCkgKiBiYWNrT2ZmQnkgKiBBRERJVElPTkFMX0RFTEFZX0ZBQ1RPUlxyXG4gIHJldHVybiBiYWNrT2ZmQnkgKyBhZGRpdGlvbmFsRGVsYXlcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlcXVlc3RXaXRoUmV0cnkoXHJcbiAgdHJhbnNwb3J0OiBUcmFuc3BvcnQsXHJcbiAgb3B0OiBodHRwcy5SZXF1ZXN0T3B0aW9ucyxcclxuICBib2R5OiBCdWZmZXIgfCBzdHJpbmcgfCBzdHJlYW0uUmVhZGFibGUgfCBudWxsID0gbnVsbCxcclxuICBtYXhSZXRyaWVzOiBudW1iZXIgPSBNQVhfUkVUUklFUyxcclxuKTogUHJvbWlzZTxodHRwLkluY29taW5nTWVzc2FnZT4ge1xyXG4gIGxldCBhdHRlbXB0ID0gMFxyXG4gIGxldCBpc1JldHJ5YWJsZSA9IGZhbHNlXHJcbiAgd2hpbGUgKGF0dGVtcHQgPD0gbWF4UmV0cmllcykge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KHRyYW5zcG9ydCwgb3B0LCBib2R5KVxyXG4gICAgICAvLyBDaGVjayBpZiB0aGUgSFRUUCBzdGF0dXMgY29kZSBpcyByZXRyeWFibGVcclxuICAgICAgaWYgKGlzSHR0cFJldHJ5YWJsZShyZXNwb25zZS5zdGF0dXNDb2RlIGFzIG51bWJlcikpIHtcclxuICAgICAgICBpc1JldHJ5YWJsZSA9IHRydWVcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFJldHJ5YWJsZSBIVFRQIHN0YXR1czogJHtyZXNwb25zZS5zdGF0dXNDb2RlfWApIC8vIHRyaWdnZXIgcmV0cnkgYXR0ZW1wdCB3aXRoIGNhbGN1bGF0ZWQgZGVsYXlcclxuICAgICAgfVxyXG5cclxuICAgICAgcmV0dXJuIHJlc3BvbnNlIC8vIFN1Y2Nlc3MsIHJldHVybiB0aGUgcmF3IHJlc3BvbnNlXHJcbiAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgaWYgKGlzUmV0cnlhYmxlKSB7XHJcbiAgICAgICAgYXR0ZW1wdCsrXHJcbiAgICAgICAgaXNSZXRyeWFibGUgPSBmYWxzZVxyXG5cclxuICAgICAgICBpZiAoYXR0ZW1wdCA+IG1heFJldHJpZXMpIHtcclxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgUmVxdWVzdCBmYWlsZWQgYWZ0ZXIgJHttYXhSZXRyaWVzfSByZXRyaWVzOiAke2Vycn1gKVxyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBkZWxheSA9IGdldEV4cEJhY2tPZmZEZWxheShhdHRlbXB0KVxyXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1jb25zb2xlXHJcbiAgICAgICAgY29uc29sZS53YXJuKFxyXG4gICAgICAgICAgYCR7bmV3IERhdGUoKS50b0xvY2FsZVN0cmluZygpfSBSZXRyeWluZyByZXF1ZXN0IChhdHRlbXB0ICR7YXR0ZW1wdH0vJHttYXhSZXRyaWVzfSkgYWZ0ZXIgJHtkZWxheX1tcyBkdWUgdG86ICR7ZXJyfWAsXHJcbiAgICAgICAgKVxyXG4gICAgICAgIGF3YWl0IHNsZWVwKGRlbGF5KVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRocm93IGVyciAvLyByZS10aHJvdyBpZiBhbnkgcmVxdWVzdCwgc3ludGF4IGVycm9yc1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICB0aHJvdyBuZXcgRXJyb3IoYCR7TUFYX1JFVFJJRVN9IFJldHJpZXMgZXhoYXVzdGVkLCByZXF1ZXN0IGZhaWxlZC5gKVxyXG59XHJcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUdBLElBQUFBLE9BQUEsR0FBQUMsT0FBQTtBQUNBLElBQUFDLEtBQUEsR0FBQUQsT0FBQTtBQUlBLE1BQU1FLGFBQWEsR0FBRyxJQUFBQyxlQUFTLEVBQUNDLGdCQUFRLENBQUM7QUFFbEMsZUFBZUMsT0FBT0EsQ0FDM0JDLFNBQW9CLEVBQ3BCQyxHQUF5QixFQUN6QkMsSUFBOEMsR0FBRyxJQUFJLEVBQ3RCO0VBQy9CLE9BQU8sSUFBSUMsT0FBTyxDQUF1QixDQUFDQyxPQUFPLEVBQUVDLE1BQU0sS0FBSztJQUM1RCxNQUFNQyxVQUFVLEdBQUdOLFNBQVMsQ0FBQ0QsT0FBTyxDQUFDRSxHQUFHLEVBQUdNLFFBQVEsSUFBSztNQUN0REgsT0FBTyxDQUFDRyxRQUFRLENBQUM7SUFDbkIsQ0FBQyxDQUFDO0lBRUZELFVBQVUsQ0FBQ0UsRUFBRSxDQUFDLE9BQU8sRUFBRUgsTUFBTSxDQUFDO0lBRTlCLElBQUksQ0FBQ0gsSUFBSSxJQUFJTyxNQUFNLENBQUNDLFFBQVEsQ0FBQ1IsSUFBSSxDQUFDLElBQUksT0FBT0EsSUFBSSxLQUFLLFFBQVEsRUFBRTtNQUM5REksVUFBVSxDQUFDSyxHQUFHLENBQUNULElBQUksQ0FBQztJQUN0QixDQUFD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