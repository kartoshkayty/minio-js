/*
 * MinIO Javascript Library for Amazon S3 Compatible Cloud Storage, (C) 2015 MinIO, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import * as errors from "./errors.mjs";
import { parseXml, sanitizeETag, sanitizeObjectKey, toArray } from "./internal/helper.mjs";

// parse XML response for bucket notification
export function parseBucketNotification(xml) {
  var result = {
    TopicConfiguration: [],
    QueueConfiguration: [],
    CloudFunctionConfiguration: []
  };
  // Parse the events list
  var genEvents = function (events) {
    var result = [];
    if (events) {
      toArray(events).forEach(s3event => {
        result.push(s3event);
      });
    }
    return result;
  };
  // Parse all filter rules
  var genFilterRules = function (filters) {
    var result = [];
    if (filters) {
      filters = toArray(filters);
      if (filters[0].S3Key) {
        filters[0].S3Key = toArray(filters[0].S3Key);
        if (filters[0].S3Key[0].FilterRule) {
          toArray(filters[0].S3Key[0].FilterRule).forEach(rule => {
            var Name = toArray(rule.Name)[0];
            var Value = toArray(rule.Value)[0];
            result.push({
              Name,
              Value
            });
          });
        }
      }
    }
    return result;
  };
  var xmlobj = parseXml(xml);
  xmlobj = xmlobj.NotificationConfiguration;

  // Parse all topic configurations in the xml
  if (xmlobj.TopicConfiguration) {
    toArray(xmlobj.TopicConfiguration).forEach(config => {
      var Id = toArray(config.Id)[0];
      var Topic = toArray(config.Topic)[0];
      var Event = genEvents(config.Event);
      var Filter = genFilterRules(config.Filter);
      result.TopicConfiguration.push({
        Id,
        Topic,
        Event,
        Filter
      });
    });
  }
  // Parse all topic configurations in the xml
  if (xmlobj.QueueConfiguration) {
    toArray(xmlobj.QueueConfiguration).forEach(config => {
      var Id = toArray(config.Id)[0];
      var Queue = toArray(config.Queue)[0];
      var Event = genEvents(config.Event);
      var Filter = genFilterRules(config.Filter);
      result.QueueConfiguration.push({
        Id,
        Queue,
        Event,
        Filter
      });
    });
  }
  // Parse all QueueConfiguration arrays
  if (xmlobj.CloudFunctionConfiguration) {
    toArray(xmlobj.CloudFunctionConfiguration).forEach(config => {
      var Id = toArray(config.Id)[0];
      var CloudFunction = toArray(config.CloudFunction)[0];
      var Event = genEvents(config.Event);
      var Filter = genFilterRules(config.Filter);
      result.CloudFunctionConfiguration.push({
        Id,
        CloudFunction,
        Event,
        Filter
      });
    });
  }
  return result;
}

// parse XML response for list objects v2 in a bucket
export function parseListObjectsV2(xml) {
  var result = {
    objects: [],
    isTruncated: false
  };
  var xmlobj = parseXml(xml);
  if (!xmlobj.ListBucketResult) {
    throw new errors.InvalidXMLError('Missing tag: "ListBucketResult"');
  }
  xmlobj = xmlobj.ListBucketResult;
  if (xmlobj.IsTruncated) {
    result.isTruncated = xmlobj.IsTruncated;
  }
  if (xmlobj.NextContinuationToken) {
    result.nextContinuationToken = xmlobj.NextContinuationToken;
  }
  if (xmlobj.Contents) {
    toArray(xmlobj.Contents).forEach(content => {
      var name = sanitizeObjectKey(toArray(content.Key)[0]);
      var lastModified = new Date(content.LastModified);
      var etag = sanitizeETag(content.ETag);
      var size = content.Size;
      result.objects.push({
        name,
        lastModified,
        etag,
        size
      });
    });
  }
  if (xmlobj.CommonPrefixes) {
    toArray(xmlobj.CommonPrefixes).forEach(commonPrefix => {
      result.objects.push({
        prefix: sanitizeObjectKey(toArray(commonPrefix.Prefix)[0]),
        size: 0
      });
    });
  }
  return result;
}

// parse XML response for list objects v2 with metadata in a bucket
export function parseListObjectsV2WithMetadata(xml) {
  var result = {
    objects: [],
    isTruncated: false
  };
  var xmlobj = parseXml(xml);
  if (!xmlobj.ListBucketResult) {
    throw new errors.InvalidXMLError('Missing tag: "ListBucketResult"');
  }
  xmlobj = xmlobj.ListBucketResult;
  if (xmlobj.IsTruncated) {
    result.isTruncated = xmlobj.IsTruncated;
  }
  if (xmlobj.NextContinuationToken) {
    result.nextContinuationToken = xmlobj.NextContinuationToken;
  }
  if (xmlobj.Contents) {
    toArray(xmlobj.Contents).forEach(content => {
      var name = sanitizeObjectKey(content.Key);
      var lastModified = new Date(content.LastModified);
      var etag = sanitizeETag(content.ETag);
      var size = content.Size;
      var metadata;
      if (content.UserMetadata != null) {
        metadata = toArray(content.UserMetadata)[0];
      } else {
        metadata = null;
      }
      result.objects.push({
        name,
        lastModified,
        etag,
        size,
        metadata
      });
    });
  }
  if (xmlobj.CommonPrefixes) {
    toArray(xmlobj.CommonPrefixes).forEach(commonPrefix => {
      result.objects.push({
        prefix: sanitizeObjectKey(toArray(commonPrefix.Prefix)[0]),
        size: 0
      });
    });
  }
  return result;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJlcnJvcnMiLCJwYXJzZVhtbCIsInNhbml0aXplRVRhZyIsInNhbml0aXplT2JqZWN0S2V5IiwidG9BcnJheSIsInBhcnNlQnVja2V0Tm90aWZpY2F0aW9uIiwieG1sIiwicmVzdWx0IiwiVG9waWNDb25maWd1cmF0aW9uIiwiUXVldWVDb25maWd1cmF0aW9uIiwiQ2xvdWRGdW5jdGlvbkNvbmZpZ3VyYXRpb24iLCJnZW5FdmVudHMiLCJldmVudHMiLCJmb3JFYWNoIiwiczNldmVudCIsInB1c2giLCJnZW5GaWx0ZXJSdWxlcyIsImZpbHRlcnMiLCJTM0tleSIsIkZpbHRlclJ1bGUiLCJydWxlIiwiTmFtZSIsIlZhbHVlIiwieG1sb2JqIiwiTm90aWZpY2F0aW9uQ29uZmlndXJhdGlvbiIsImNvbmZpZyIsIklkIiwiVG9waWMiLCJFdmVudCIsIkZpbHRlciIsIlF1ZXVlIiwiQ2xvdWRGdW5jdGlvbiIsInBhcnNlTGlzdE9iamVjdHNWMiIsIm9iamVjdHMiLCJpc1RydW5jYXRlZCIsIkxpc3RCdWNrZXRSZXN1bHQiLCJJbnZhbGlkWE1MRXJyb3IiLCJJc1RydW5jYXRlZCIsIk5leHRDb250aW51YXRpb25Ub2tlbiIsIm5leHRDb250aW51YXRpb25Ub2tlbiIsIkNvbnRlbnRzIiwiY29udGVudCIsIm5hbWUiLCJLZXkiLCJsYXN0TW9kaWZpZWQiLCJEYXRlIiwiTGFzdE1vZGlmaWVkIiwiZXRhZyIsIkVUYWciLCJzaXplIiwiU2l6ZSIsIkNvbW1vblByZWZpeGVzIiwiY29tbW9uUHJlZml4IiwicHJlZml4IiwiUHJlZml4IiwicGFyc2VMaXN0T2JqZWN0c1YyV2l0aE1ldGFkYXRhIiwibWV0YWRhdGEiLCJVc2VyTWV0YWRhdGEiXSwic291cmNlcyI6WyJ4bWwtcGFyc2Vycy5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKlxyXG4gKiBNaW5JTyBKYXZhc2NyaXB0IExpYnJhcnkgZm9yIEFtYXpvbiBTMyBDb21wYXRpYmxlIENsb3VkIFN0b3JhZ2UsIChDKSAyMDE1IE1pbklPLCBJbmMuXHJcbiAqXHJcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcbiAqXHJcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuICpcclxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxyXG4gKi9cclxuXHJcbmltcG9ydCAqIGFzIGVycm9ycyBmcm9tICcuL2Vycm9ycy50cydcclxuaW1wb3J0IHsgcGFyc2VYbWwsIHNhbml0aXplRVRhZywgc2FuaXRpemVPYmplY3RLZXksIHRvQXJyYXkgfSBmcm9tICcuL2ludGVybmFsL2hlbHBlci50cydcclxuXHJcbi8vIHBhcnNlIFhNTCByZXNwb25zZSBmb3IgYnVja2V0IG5vdGlmaWNhdGlvblxyXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VCdWNrZXROb3RpZmljYXRpb24oeG1sKSB7XHJcbiAgdmFyIHJlc3VsdCA9IHtcclxuICAgIFRvcGljQ29uZmlndXJhdGlvbjogW10sXHJcbiAgICBRdWV1ZUNvbmZpZ3VyYXRpb246IFtdLFxyXG4gICAgQ2xvdWRGdW5jdGlvbkNvbmZpZ3VyYXRpb246IFtdLFxyXG4gIH1cclxuICAvLyBQYXJzZSB0aGUgZXZlbnRzIGxpc3RcclxuICB2YXIgZ2VuRXZlbnRzID0gZnVuY3Rpb24gKGV2ZW50cykge1xyXG4gICAgdmFyIHJlc3VsdCA9IFtdXHJcbiAgICBpZiAoZXZlbnRzKSB7XHJcbiAgICAgIHRvQXJyYXkoZXZlbnRzKS5mb3JFYWNoKChzM2V2ZW50KSA9PiB7XHJcbiAgICAgICAgcmVzdWx0LnB1c2goczNldmVudClcclxuICAgICAgfSlcclxuICAgIH1cclxuICAgIHJldHVybiByZXN1bHRcclxuICB9XHJcbiAgLy8gUGFyc2UgYWxsIGZpbHRlciBydWxlc1xyXG4gIHZhciBnZW5GaWx0ZXJSdWxlcyA9IGZ1bmN0aW9uIChmaWx0ZXJzKSB7XHJcbiAgICB2YXIgcmVzdWx0ID0gW11cclxuICAgIGlmIChmaWx0ZXJzKSB7XHJcbiAgICAgIGZpbHRlcnMgPSB0b0FycmF5KGZpbHRlcnMpXHJcbiAgICAgIGlmIChmaWx0ZXJzWzBdLlMzS2V5KSB7XHJcbiAgICAgICAgZmlsdGVyc1swXS5TM0tleSA9IHRvQXJyYXkoZmlsdGVyc1swXS5TM0tleSlcclxuICAgICAgICBpZiAoZmlsdGVyc1swXS5TM0tleVswXS5GaWx0ZXJSdWxlKSB7XHJcbiAgICAgICAgICB0b0FycmF5KGZpbHRlcnNbMF0uUzNLZXlbMF0uRmlsdGVyUnVsZSkuZm9yRWFjaCgocnVsZSkgPT4ge1xyXG4gICAgICAgICAgICB2YXIgTmFtZSA9IHRvQXJyYXkocnVsZS5OYW1lKVswXVxyXG4gICAgICAgICAgICB2YXIgVmFsdWUgPSB0b0FycmF5KHJ1bGUuVmFsdWUpWzBdXHJcbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKHsgTmFtZSwgVmFsdWUgfSlcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzdWx0XHJcbiAgfVxyXG5cclxuICB2YXIgeG1sb2JqID0gcGFyc2VYbWwoeG1sKVxyXG4gIHhtbG9iaiA9IHhtbG9iai5Ob3RpZmljYXRpb25Db25maWd1cmF0aW9uXHJcblxyXG4gIC8vIFBhcnNlIGFsbCB0b3BpYyBjb25maWd1cmF0aW9ucyBpbiB0aGUgeG1sXHJcbiAgaWYgKHhtbG9iai5Ub3BpY0NvbmZpZ3VyYXRpb24pIHtcclxuICAgIHRvQXJyYXkoeG1sb2JqLlRvcGljQ29uZmlndXJhdGlvbikuZm9yRWFjaCgoY29uZmlnKSA9PiB7XHJcbiAgICAgIHZhciBJZCA9IHRvQXJyYXkoY29uZmlnLklkKVswXVxyXG4gICAgICB2YXIgVG9waWMgPSB0b0FycmF5KGNvbmZpZy5Ub3BpYylbMF1cclxuICAgICAgdmFyIEV2ZW50ID0gZ2VuRXZlbnRzKGNvbmZpZy5FdmVudClcclxuICAgICAgdmFyIEZpbHRlciA9IGdlbkZpbHRlclJ1bGVzKGNvbmZpZy5GaWx0ZXIpXHJcbiAgICAgIHJlc3VsdC5Ub3BpY0NvbmZpZ3VyYXRpb24ucHVzaCh7IElkLCBUb3BpYywgRXZlbnQsIEZpbHRlciB9KVxyXG4gICAgfSlcclxuICB9XHJcbiAgLy8gUGFyc2UgYWxsIHRvcGljIGNvbmZpZ3VyYXRpb25zIGluIHRoZSB4bWxcclxuICBpZiAoeG1sb2JqLlF1ZXVlQ29uZmlndXJhdGlvbikge1xyXG4gICAgdG9BcnJheSh4bWxvYmouUXVldWVDb25maWd1cmF0aW9uKS5mb3JFYWNoKChjb25maWcpID0+IHtcclxuICAgICAgdmFyIElkID0gdG9BcnJheShjb25maWcuSWQpWzBdXHJcbiAgICAgIHZhciBRdWV1ZSA9IHRvQXJyYXkoY29uZmlnLlF1ZXVlKVswXVxyXG4gICAgICB2YXIgRXZlbnQgPSBnZW5FdmVudHMoY29uZmlnLkV2ZW50KVxyXG4gICAgICB2YXIgRmlsdGVyID0gZ2VuRmlsdGVyUnVsZXMoY29uZmlnLkZpbHRlcilcclxuICAgICAgcmVzdWx0LlF1ZXVlQ29uZmlndXJhdGlvbi5wdXNoKHsgSWQsIFF1ZXVlLCBFdmVudCwgRmlsdGVyIH0pXHJcbiAgICB9KVxyXG4gIH1cclxuICAvLyBQYXJzZSBhbGwgUXVldWVDb25maWd1cmF0aW9uIGFycmF5c1xyXG4gIGlmICh4bWxvYmouQ2xvdWRGdW5jdGlvbkNvbmZpZ3VyYXRpb24pIHtcclxuICAgIHRvQXJyYXkoeG1sb2JqLkNsb3VkRnVuY3Rpb25Db25maWd1cmF0aW9uKS5mb3JFYWNoKChjb25maWcpID0+IHtcclxuICAgICAgdmFyIElkID0gdG9BcnJheShjb25maWcuSWQpWzBdXHJcbiAgICAgIHZhciBDbG91ZEZ1bmN0aW9uID0gdG9BcnJheShjb25maWcuQ2xvdWRGdW5jdGlvbilbMF1cclxuICAgICAgdmFyIEV2ZW50ID0gZ2VuRXZlbnRzKGNvbmZpZy5FdmVudClcclxuICAgICAgdmFyIEZpbHRlciA9IGdlbkZpbHRlclJ1bGVzKGNvbmZpZy5GaWx0ZXIpXHJcbiAgICAgIHJlc3VsdC5DbG91ZEZ1bmN0aW9uQ29uZmlndXJhdGlvbi5wdXNoKHsgSWQsIENsb3VkRnVuY3Rpb24sIEV2ZW50LCBGaWx0ZXIgfSlcclxuICAgIH0pXHJcbiAgfVxyXG5cclxuICByZXR1cm4gcmVzdWx0XHJcbn1cclxuXHJcbi8vIHBhcnNlIFhNTCByZXNwb25zZSBmb3IgbGlzdCBvYmplY3RzIHYyIGluIGEgYnVja2V0XHJcbmV4cG9ydCBmdW5jdGlvbiBwYXJzZUxpc3RPYmplY3RzVjIoeG1sKSB7XHJcbiAgdmFyIHJlc3VsdCA9IHtcclxuICAgIG9iamVjdHM6IFtdLFxyXG4gICAgaXNUcnVuY2F0ZWQ6IGZhbHNlLFxyXG4gIH1cclxuICB2YXIgeG1sb2JqID0gcGFyc2VYbWwoeG1sKVxyXG4gIGlmICgheG1sb2JqLkxpc3RCdWNrZXRSZXN1bHQpIHtcclxuICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZFhNTEVycm9yKCdNaXNzaW5nIHRhZzogXCJMaXN0QnVja2V0UmVzdWx0XCInKVxyXG4gIH1cclxuICB4bWxvYmogPSB4bWxvYmouTGlzdEJ1Y2tldFJlc3VsdFxyXG4gIGlmICh4bWxvYmouSXNUcnVuY2F0ZWQpIHtcclxuICAgIHJlc3VsdC5pc1RydW5jYXRlZCA9IHhtbG9iai5Jc1RydW5jYXRlZFxyXG4gIH1cclxuICBpZiAoeG1sb2JqLk5leHRDb250aW51YXRpb25Ub2tlbikge1xyXG4gICAgcmVzdWx0Lm5leHRDb250aW51YXRpb25Ub2tlbiA9IHhtbG9iai5OZXh0Q29udGludWF0aW9uVG9rZW5cclxuICB9XHJcbiAgaWYgKHhtbG9iai5Db250ZW50cykge1xyXG4gICAgdG9BcnJheSh4bWxvYmouQ29udGVudHMpLmZvckVhY2goKGNvbnRlbnQpID0+IHtcclxuICAgICAgdmFyIG5hbWUgPSBzYW5pdGl6ZU9iamVjdEtleSh0b0FycmF5KGNvbnRlbnQuS2V5KVswXSlcclxuICAgICAgdmFyIGxhc3RNb2RpZmllZCA9IG5ldyBEYXRlKGNvbnRlbnQuTGFzdE1vZGlmaWVkKVxyXG4gICAgICB2YXIgZXRhZyA9IHNhbml0aXplRVRhZyhjb250ZW50LkVUYWcpXHJcbiAgICAgIHZhciBzaXplID0gY29udGVudC5TaXplXHJcbiAgICAgIHJlc3VsdC5vYmplY3RzLnB1c2goeyBuYW1lLCBsYXN0TW9kaWZpZWQsIGV0YWcsIHNpemUgfSlcclxuICAgIH0pXHJcbiAgfVxyXG4gIGlmICh4bWxvYmouQ29tbW9uUHJlZml4ZXMpIHtcclxuICAgIHRvQXJyYXkoeG1sb2JqLkNvbW1vblByZWZpeGVzKS5mb3JFYWNoKChjb21tb25QcmVmaXgpID0+IHtcclxuICAgICAgcmVzdWx0Lm9iamVjdHMucHVzaCh7IHByZWZpeDogc2FuaXRpemVPYmplY3RLZXkodG9BcnJheShjb21tb25QcmVmaXguUHJlZml4KVswXSksIHNpemU6IDAgfSlcclxuICAgIH0pXHJcbiAgfVxyXG4gIHJldHVybiByZXN1bHRcclxufVxyXG5cclxuLy8gcGFyc2UgWE1MIHJlc3BvbnNlIGZvciBsaXN0IG9iamVjdHMgdjIgd2l0aCBtZXRhZGF0YSBpbiBhIGJ1Y2tldFxyXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VMaXN0T2JqZWN0c1YyV2l0aE1ldGFkYXRhKHhtbCkge1xyXG4gIHZhciByZXN1bHQgPSB7XHJcbiAgICBvYmplY3RzOiBbXSxcclxuICAgIGlzVHJ1bmNhdGVkOiBmYWxzZSxcclxuICB9XHJcbiAgdmFyIHhtbG9iaiA9IHBhcnNlWG1sKHhtbClcclxuICBpZiAoIXhtbG9iai5MaXN0QnVja2V0UmVzdWx0KSB7XHJcbiAgICB0aHJvdyBuZXcgZXJyb3JzLkludmFsaWRYTUxFcnJvcignTWlzc2luZyB0YWc6IFwiTGlzdEJ1Y2tldFJlc3VsdFwiJylcclxuICB9XHJcbiAgeG1sb2JqID0geG1sb2JqLkxpc3RCdWNrZXRSZXN1bHRcclxuICBpZiAoeG1sb2JqLklzVHJ1bmNhdGVkKSB7XHJcbiAgICByZXN1bHQuaXNUcnVuY2F0ZWQgPSB4bWxvYmouSXNUcnVuY2F0ZWRcclxuICB9XHJcbiAgaWYgKHhtbG9iai5OZXh0Q29udGludWF0aW9uVG9rZW4pIHtcclxuICAgIHJlc3VsdC5uZXh0Q29udGludWF0aW9uVG9rZW4gPSB4bWxvYmouTmV4dENvbnRpbnVhdGlvblRva2VuXHJcbiAgfVxyXG5cclxuICBpZiAoeG1sb2JqLkNvbnRlbnRzKSB7XHJcbiAgICB0b0FycmF5KHhtbG9iai5Db250ZW50cykuZm9yRWFjaCgoY29udGVudCkgPT4ge1xyXG4gICAgICB2YXIgbmFtZSA9IHNhbml0aXplT2JqZWN0S2V5KGNvbnRlbnQuS2V5KVxyXG4gICAgICB2YXIgbGFzdE1vZGlmaWVkID0gbmV3IERhdGUoY29udGVudC5MYXN0TW9kaWZpZWQpXHJcbiAgICAgIHZhciBldGFnID0gc2FuaXRpemVFVGFnKGNvbnRlbnQuRVRhZylcclxuICAgICAgdmFyIHNpemUgPSBjb250ZW50LlNpemVcclxuICAgICAgdmFyIG1ldGFkYXRhXHJcbiAgICAgIGlmIChjb250ZW50LlVzZXJNZXRhZGF0YSAhPSBudWxsKSB7XHJcbiAgICAgICAgbWV0YWRhdGEgPSB0b0FycmF5KGNvbnRlbnQuVXNlck1ldGFkYXRhKVswXVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIG1ldGFkYXRhID0gbnVsbFxyXG4gICAgICB9XHJcbiAgICAgIHJlc3VsdC5vYmplY3RzLnB1c2goeyBuYW1lLCBsYXN0TW9kaWZpZWQsIGV0YWcsIHNpemUsIG1ldGFkYXRhIH0pXHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgaWYgKHhtbG9iai5Db21tb25QcmVmaXhlcykge1xyXG4gICAgdG9BcnJheSh4bWxvYmouQ29tbW9uUHJlZml4ZXMpLmZvckVhY2goKGNvbW1vblByZWZpeCkgPT4ge1xyXG4gICAgICByZXN1bHQub2JqZWN0cy5wdXNoKHsgcHJlZml4OiBzYW5pdGl6ZU9iamVjdEtleSh0b0FycmF5KGNvbW1vblByZWZpeC5QcmVmaXgpWzBdKSwgc2l6ZTogMCB9KVxyXG4gICAgfSlcclxuICB9XHJcbiAgcmV0dXJuIHJlc3VsdFxyXG59XHJcbiJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU8sS0FBS0EsTUFBTSxNQUFNLGNBQWE7QUFDckMsU0FBU0MsUUFBUSxFQUFFQyxZQUFZLEVBQUVDLGlCQUFpQixFQUFFQyxPQUFPLFFBQVEsdUJBQXNCOztBQUV6RjtBQUNBLE9BQU8sU0FBU0MsdUJBQXVCQSxDQUFDQyxHQUFHLEVBQUU7RUFDM0MsSUFBSUMsTUFBTSxHQUFHO0lBQ1hDLGtCQUFrQixFQUFFLEVBQUU7SUFDdEJDLGtCQUFrQixFQUFFLEVBQUU7SUFDdEJDLDBCQUEwQixFQUFFO0VBQzlCLENBQUM7RUFDRDtFQUNBLElBQUlDLFNBQVMsR0FBRyxTQUFBQSxDQUFVQyxNQUFNLEVBQUU7SUFDaEMsSUFBSUwsTUFBTSxHQUFHLEVBQUU7SUFDZixJQUFJSyxNQUFNLEVBQUU7TUFDVlIsT0FBTyxDQUFDUSxNQUFNLENBQUMsQ0FBQ0MsT0FBTyxDQUFFQyxPQUFPLElBQUs7UUFDbkNQLE1BQU0sQ0FBQ1EsSUFBSSxDQUFDRCxPQUFPLENBQUM7TUFDdEIsQ0FBQyxDQUFDO0lBQ0o7SUFDQSxPQUFPUCxNQUFNO0VBQ2YsQ0FBQztFQUNEO0VBQ0EsSUFBSVMsY0FBYyxHQUFHLFNBQUFBLENBQVVDLE9BQU8sRUFBRTtJQUN0QyxJQUFJVixNQUFNLEdBQUcsRUFBRTtJQUNmLElBQUlVLE9BQU8sRUFBRTtNQUNYQSxPQUFPLEdBQUdiLE9BQU8sQ0FBQ2EsT0FBTyxDQUFDO01BQzFCLElBQUlBLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQ0MsS0FBSyxFQUFFO1FBQ3BCRCxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUNDLEtBQUssR0FBR2QsT0FBTyxDQUFDYSxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUNDLEtBQUssQ0FBQztRQUM1QyxJQUFJRCxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUNDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQ0MsVUFBVSxFQUFFO1VBQ2xDZixPQUFPLENBQUNhLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQ0MsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDQyxVQUFVLENBQUMsQ0FBQ04sT0FBTyxDQUFFTyxJQUFJLElBQUs7WUFDeEQsSUFBSUMsSUFBSSxHQUFHakIsT0FBTyxDQUFDZ0IsSUFBSSxDQUFDQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDaEMsSUFBSUMsS0FBSyxHQUFHbEIsT0FBTyxDQUFDZ0IsSUFBSSxDQUFDRSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbENmLE1BQU0sQ0FBQ1EsSUFBSSxDQUFDO2NBQUVNLElBQUk7Y0FBRUM7WUFBTSxDQUFDLENBQUM7VUFDOUIsQ0FBQyxDQUFDO1FBQ0o7TUFDRjtJQUNGO0lBQ0EsT0FBT2YsTUFBTTtFQUNmLENBQUM7RUFFRCxJQUFJZ0IsTUFBTSxHQUFHdEIsUUFBUSxDQUFDSyxHQUFHLENBQUM7RUFDMUJpQixNQUFNLEdBQUdBLE1BQU0sQ0FBQ0MseUJBQXlCOztFQUV6QztFQUNBLElBQUlELE1BQU0sQ0FBQ2Ysa0JBQWtCLEVBQUU7SUFDN0JKLE9BQU8sQ0FBQ21CLE1BQU0sQ0FBQ2Ysa0JBQWtCLENBQUMsQ0FBQ0ssT0FBTyxDQUFFWSxNQUFNLElBQUs7TUFDckQsSUFBSUMsRUFBRSxHQUFHdEIsT0FBTyxDQUFDcUIsTUFBTSxDQUFDQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7TUFDOUIsSUFBSUMsS0FBSyxHQUFHdkIsT0FBTyxDQUFDcUIsTUFBTSxDQUFDRSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7TUFDcEMsSUFBSUMsS0FBSyxHQUFHakIsU0FBUyxDQUFDYyxNQUFNLENBQUNHLEtBQUssQ0FBQztNQUNuQyxJQUFJQyxNQUFNLEdBQUdiLGNBQWMsQ0FBQ1MsTUFBTSxDQUFDSSxNQUFNLENBQUM7TUFDMUN0QixNQUFNLENBQUNDLGtCQUFrQixDQUFDTyxJQUFJLENBQUM7UUFBRVcsRUFBRTtRQUFFQyxLQUFLO1FBQUVDLEtBQUs7UUFBRUM7TUFBTyxDQUFDLENBQUM7SUFDOUQsQ0FBQyxDQUFDO0VBQ0o7RUFDQTtFQUNBLElBQUlOLE1BQU0sQ0FBQ2Qsa0JBQWtCLEVBQUU7SUFDN0JMLE9BQU8sQ0FBQ21CLE1BQU0sQ0FBQ2Qsa0JBQWtCLENBQUMsQ0FBQ0ksT0FBTyxDQUFFWSxNQUFNLElBQUs7TUFDckQsSUFBSUMsRUFBRSxHQUFHdEIsT0FBTyxDQUFDcUIsTUFBTSxDQUFDQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7TUFDOUIsSUFBSUksS0FBSyxHQUFHMUIsT0FBTyxDQUFDcUIsTUFBTSxDQUFDSyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7TUFDcEMsSUFBSUYsS0FBSyxHQUFHakIsU0FBUyxDQUFDYyxNQUFNLENBQUNHLEtBQUssQ0FBQztNQUNuQyxJQUFJQyxNQUFNLEdBQUdiLGNBQWMsQ0FBQ1MsTUFBTSxDQUFDSSxNQUFNLENBQUM7TUFDMUN0QixNQUFNLENBQUNFLGtCQUFrQixDQUFDTSxJQUFJLENBQUM7UUFBRVcsRUFBRTtRQUFFSSxLQUFLO1FBQUVGLEtBQUs7UUFBRUM7TUFBTyxDQUFDLENBQUM7SUFDOUQsQ0FBQyxDQUFDO0VBQ0o7RUFDQTtFQUNBLElBQUlOLE1BQU0sQ0FBQ2IsMEJBQTBCLEVBQUU7SUFDckNOLE9BQU8sQ0FBQ21CLE1BQU0sQ0FBQ2IsMEJBQTBCLENBQUMsQ0FBQ0csT0FBTyxDQUFFWSxNQUFNLElBQUs7TUFDN0QsSUFBSUMsRUFBRSxHQUFHdEIsT0FBTyxDQUFDcUIsTUFBTSxDQUFDQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7TUFDOUIsSUFBSUssYUFBYSxHQUFHM0IsT0FBTyxDQUFDcUIsTUFBTSxDQUFDTSxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUM7TUFDcEQsSUFBSUgsS0FBSyxHQUFHakIsU0FBUyxDQUFDYyxNQUFNLENBQUNHLEtBQUssQ0FBQztNQUNuQyxJQUFJQyxNQUFNLEdBQUdiLGNBQWMsQ0FBQ1MsTUFBTSxDQUFDSSxNQUFNLENBQUM7TUFDMUN0QixNQUFNLENBQUNHLDBCQUEwQixDQUFDSyxJQUFJLENBQUM7UUFBRVcsRUFBRTtRQUFFSyxhQUFhO1FBQUVILEtBQUs7UUFBRUM7TUFBTyxDQUFDLENBQUM7SUFDOUUsQ0FBQyxDQUFDO0VBQ0o7RUFFQSxPQUFPdEIsTUFBTTtBQUNmOztBQUVBO0FBQ0EsT0FBTyxTQUFTeUIsa0JBQWtCQSxDQUFDMUIsR0FBRyxFQUFFO0VBQ3RDLElBQUlDLE1BQU0sR0FBRztJQUNYMEIsT0FBTyxFQUFFLEVBQUU7SUFDWEMsV0FBVyxFQUFFO0VBQ2YsQ0FBQztFQUNELElBQUlYLE1BQU0sR0FBR3RCLFFBQVEsQ0FBQ0ssR0FBRyxDQUFDO0VBQzFCLElBQUksQ0FBQ2lCLE1BQU0sQ0FBQ1ksZ0JBQWdCLEVBQUU7SUFDNUIsTUFBTSxJQUFJbkMsTUFBTSxDQUFDb0MsZUFBZSxDQUFDLGlDQUFpQyxDQUFDO0VBQ3JFO0VBQ0FiLE1BQU0sR0FBR0EsTUFBTSxDQUFDWSxnQkFBZ0I7RUFDaEMsSUFBSVosTUFBTSxDQUFDYyxXQUFXLEVBQUU7SUFDdEI5QixNQUFNLENBQUMyQixXQUFXLEdBQUdYLE1BQU0sQ0FBQ2MsV0FBVztFQUN6QztFQUNBLElBQUlkLE1BQU0sQ0FBQ2UscUJBQXFCLEVBQUU7SUFDaEMvQixNQUFNLENBQUNnQyxxQkFBcUIsR0FBR2hCLE1BQU0sQ0FBQ2UscUJBQXFCO0VBQzdEO0VBQ0EsSUFBSWYsTUFBTSxDQUFDaUIsUUFBUSxFQUFFO0lBQ25CcEMsT0FBTyxDQUFDbUIsTUFBTSxDQUFDaUIsUUFBUSxDQUFDLENBQUMzQixPQUFPLENBQUU0QixPQUFPLElBQUs7TUFDNUMsSUFBSUMsSUFBSSxHQUFHdkMsaUJBQWlCLENBQUNDLE9BQU8sQ0FBQ3FDLE9BQU8sQ0FBQ0UsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7TUFDckQsSUFBSUMsWUFBWSxHQUFHLElBQUlDLElBQUksQ0FBQ0osT0FBTyxDQUFDSyxZQUFZLENBQUM7TUFDakQsSUFBSUMsSUFBSSxHQUFHN0MsWUFBWSxDQUFDdUMsT0FBTyxDQUFDTyxJQUFJLENBQUM7TUFDckMsSUFBSUMsSUFBSSxHQUFHUixPQUFPLENBQUNTLElBQUk7TUFDdkIzQyxNQUFNLENBQUMwQixPQUFPLENBQUNsQixJQUFJLENBQUM7UUFBRTJCLElBQUk7UUFBRUUsWUFBWTtRQUFFRyxJQUFJO1FBQUVFO01BQUssQ0FBQyxDQUFDO0lBQ3pELENBQUMsQ0FBQztFQUNKO0VBQ0EsSUFBSTFCLE1BQU0sQ0FBQzRCLGNBQWMsRUFBRTtJQUN6Qi9DLE9BQU8sQ0FBQ21CLE1BQU0sQ0FBQzRCLGNBQWMsQ0FBQyxDQUFDdEMsT0FBTyxDQUFFdUMsWUFBWSxJQUFLO01BQ3ZEN0MsTUFBTSxDQUFDMEIsT0FBTyxDQUFDbEIsSUFBSSxDQUFDO1FBQUVzQyxNQUFNLEVBQUVsRCxpQkFBaUIsQ0FBQ0MsT0FBTyxDQUFDZ0QsWUFBWSxDQUFDRSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUFFTCxJQUFJLEVBQUU7TUFBRSxDQUFDLENBQUM7SUFDOUYsQ0FBQyxDQUFDO0VBQ0o7RUFDQSxPQUFPMUMsTUFBTTtBQUNmOztBQUVBO0FBQ0EsT0FBTyxTQUFTZ0QsOEJBQThCQSxDQUFDakQsR0FBRyxFQUFFO0VBQ2xELElBQUlDLE1BQU0sR0FBRztJQUNYMEIsT0FBTyxFQUFFLEVBQUU7SUFDWEMsV0FBVyxFQUFFO0VBQ2YsQ0FBQztFQUNELElBQUlYLE1BQU0sR0FBR3RCLFFBQVEsQ0FBQ0ssR0FBRyxDQUFDO0VBQzFCLElBQUksQ0FBQ2lCLE1BQU0sQ0FBQ1ksZ0JBQWdCLEVBQUU7SUFDNUIsTUFBTSxJQUFJbkMsTUFBTSxDQUFDb0MsZUFBZSxDQUFDLGlDQUFpQyxDQUFDO0VBQ3JFO0VBQ0FiLE1BQU0sR0FBR0EsTUFBTSxDQUFDWSxnQkFBZ0I7RUFDaEMsSUFBSVosTUFBTSxDQUFDYyxXQUFXLEVBQUU7SUFDdEI5QixNQUFNLENBQUMyQixXQUFXLEdBQUdYLE1BQU0sQ0FBQ2MsV0FBVztFQUN6QztFQUNBLElBQUlkLE1BQU0sQ0FBQ2UscUJBQXFCLEVBQUU7SUFDaEMvQixNQUFNLENBQUNnQyxxQkFBcUIsR0FBR2hCLE1BQU0sQ0FBQ2UscUJBQXFCO0VBQzdEO0VBRUEsSUFBSWYsTUFBTSxDQUFDaUIsUUFBUSxFQUFFO0lBQ25CcEMsT0FBTyxDQUFDbUIsTUFBTSxDQUFDaUIsUUFBUSxDQUFDLENBQUMzQixPQUFPLENBQUU0QixPQUFPLElBQUs7TUFDNUMsSUFBSUMsSUFBSSxHQUFHdkMsaUJBQWlCLENBQUNzQyxPQUFPLENBQUNFLEdBQUcsQ0FBQztNQUN6QyxJQUFJQyxZQUFZLEdBQUcsSUFBSUMsSUFBSSxDQUFDSixPQUFPLENBQUNLLFlBQVksQ0FBQztNQUNqRCxJQUFJQyxJQUFJLEdBQUc3QyxZQUFZLENBQUN1QyxPQUFPLENBQUNPLElBQUksQ0FBQztNQUNyQyxJQUFJQyxJQUFJLEdBQUdSLE9BQU8sQ0FBQ1MsSUFBSTtNQUN2QixJQUFJTSxRQUFRO01BQ1osSUFBSWYsT0FBTyxDQUFDZ0IsWUFBWSxJQUFJLElBQUksRUFBRTtRQUNoQ0QsUUFBUSxHQUFHcEQsT0FBTyxDQUFDcUMsT0FBTyxDQUFDZ0IsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO01BQzdDLENBQUMsTUFBTTtRQUNMRCxRQUFRLEdBQUcsSUFBSTtNQUNqQjtNQUNBakQsTUFBTSxDQUFDMEIsT0FBTyxDQUFDbEIsSUFBSSxDQUFDO1FBQUUyQixJQUFJO1FBQUVFLFlBQVk7UUFBRUcsSUFBSTtRQUFFRSxJQUFJO1FBQUVPO01BQVMsQ0FBQyxDQUFDO0lBQ25FLENBQUMsQ0FBQztFQUNKO0VBRUEsSUFBSWpDLE1BQU0sQ0FBQzRCLGNBQWMsRUFBRTtJQUN6Qi9DLE9BQU8sQ0FBQ21CLE1BQU0sQ0FBQzRCLGNBQWMsQ0FBQyxDQUFDdEMsT0FBTyxDQUFFdUMsWUFBWSxJQUFLO01BQ3ZEN0MsTUFBTSxDQUFDMEIsT0FBTyxDQUFDbEIsSUFBSSxDQUFDO1FBQUVzQyxNQUFNLEVBQUVsRCxpQkFBaUIsQ0FBQ0MsT0FBTyxDQUFDZ0QsWUFBWSxDQUFDRSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUFFTCxJQUFJLEVBQUU7TUFBRSxDQUFDLENBQUM7SUFDOUYsQ0FBQyxDQUFDO0VBQ0o7RUFDQSxPQUFPMUMsTUFBTTtBQUNmIiwiaWdub3JlTGlzdCI6W119