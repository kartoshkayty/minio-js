import { pipeline } from "stream";
import { promisify } from "util";
const pipelineAsync = promisify(pipeline);
export async function request(transport, opt, body = null) {
  return new Promise((resolve, reject) => {
    const requestObj = transport.request(opt, response => {
      resolve(response);
    });
    requestObj.on('error', reject);
    if (!body || Buffer.isBuffer(body) || typeof body === 'string') {
      requestObj.end(body);
    } else {
      pipelineAsync(body, requestObj).catch(reject);
    }
  });
}
const MAX_RETRIES = 2;
const EXP_BACK_OFF_BASE_DELAY = 1000; // Base delay for exponential backoff
const ADDITIONAL_DELAY_FACTOR = 1.0; // to avoid synchronized retries

// Retryable error codes for HTTP ( ref: minio-go)
export const retryHttpCodes = {
  408: true,
  429: true,
  499: true,
  500: true,
  502: true,
  503: true,
  504: true,
  520: true
};
const isHttpRetryable = httpResCode => {
  return retryHttpCodes[httpResCode] !== undefined;
};
const sleep = ms => {
  return new Promise(resolve => setTimeout(resolve, ms));
};
const getExpBackOffDelay = retryCount => {
  const backOffBy = EXP_BACK_OFF_BASE_DELAY * 2 ** retryCount;
  const additionalDelay = Math.random() * backOffBy * ADDITIONAL_DELAY_FACTOR;
  return backOffBy + additionalDelay;
};
export async function requestWithRetry(transport, opt, body = null, maxRetries = MAX_RETRIES) {
  let attempt = 0;
  let isRetryable = false;
  while (attempt <= maxRetries) {
    try {
      const response = await request(transport, opt, body);
      // Check if the HTTP status code is retryable
      if (isHttpRetryable(response.statusCode)) {
        isRetryable = true;
        throw new Error(`Retryable HTTP status: ${response.statusCode}`); // trigger retry attempt with calculated delay
      }
      return response; // Success, return the raw response
    } catch (err) {
      if (isRetryable) {
        attempt++;
        isRetryable = false;
        if (attempt > maxRetries) {
          throw new Error(`Request failed after ${maxRetries} retries: ${err}`);
        }
        const delay = getExpBackOffDelay(attempt);
        // eslint-disable-next-line no-console
        console.warn(`${new Date().toLocaleString()} Retrying request (attempt ${attempt}/${maxRetries}) after ${delay}ms due to: ${err}`);
        await sleep(delay);
      } else {
        throw err; // re-throw if any request, syntax errors
      }
    }
  }
  throw new Error(`${MAX_RETRIES} Retries exhausted, request failed.`);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJwaXBlbGluZSIsInByb21pc2lmeSIsInBpcGVsaW5lQXN5bmMiLCJyZXF1ZXN0IiwidHJhbnNwb3J0Iiwib3B0IiwiYm9keSIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwicmVxdWVzdE9iaiIsInJlc3BvbnNlIiwib24iLCJCdWZmZXIiLCJpc0J1ZmZlciIsImVuZCIsImNhdGNoIiwiTUFYX1JFVFJJRVMiLCJFWFBfQkFDS19PRkZfQkFTRV9ERUxBWSIsIkFERElUSU9OQUxfREVMQVlfRkFDVE9SIiwicmV0cnlIdHRwQ29kZXMiLCJpc0h0dHBSZXRyeWFibGUiLCJodHRwUmVzQ29kZSIsInVuZGVmaW5lZCIsInNsZWVwIiwibXMiLCJzZXRUaW1lb3V0IiwiZ2V0RXhwQmFja09mZkRlbGF5IiwicmV0cnlDb3VudCIsImJhY2tPZmZCeSIsImFkZGl0aW9uYWxEZWxheSIsIk1hdGgiLCJyYW5kb20iLCJyZXF1ZXN0V2l0aFJldHJ5IiwibWF4UmV0cmllcyIsImF0dGVtcHQiLCJpc1JldHJ5YWJsZSIsInN0YXR1c0NvZGUiLCJFcnJvciIsImVyciIsImRlbGF5IiwiY29uc29sZSIsIndhcm4iLCJEYXRlIiwidG9Mb2NhbGVTdHJpbmciXSwic291cmNlcyI6WyJyZXF1ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlICogYXMgaHR0cCBmcm9tICdub2RlOmh0dHAnXHJcbmltcG9ydCB0eXBlICogYXMgaHR0cHMgZnJvbSAnbm9kZTpodHRwcydcclxuaW1wb3J0IHR5cGUgKiBhcyBzdHJlYW0gZnJvbSAnbm9kZTpzdHJlYW0nXHJcbmltcG9ydCB7IHBpcGVsaW5lIH0gZnJvbSAnbm9kZTpzdHJlYW0nXHJcbmltcG9ydCB7IHByb21pc2lmeSB9IGZyb20gJ25vZGU6dXRpbCdcclxuXHJcbmltcG9ydCB0eXBlIHsgVHJhbnNwb3J0IH0gZnJvbSAnLi90eXBlLnRzJ1xyXG5cclxuY29uc3QgcGlwZWxpbmVBc3luYyA9IHByb21pc2lmeShwaXBlbGluZSlcclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZXF1ZXN0KFxyXG4gIHRyYW5zcG9ydDogVHJhbnNwb3J0LFxyXG4gIG9wdDogaHR0cHMuUmVxdWVzdE9wdGlvbnMsXHJcbiAgYm9keTogQnVmZmVyIHwgc3RyaW5nIHwgc3RyZWFtLlJlYWRhYmxlIHwgbnVsbCA9IG51bGwsXHJcbik6IFByb21pc2U8aHR0cC5JbmNvbWluZ01lc3NhZ2U+IHtcclxuICByZXR1cm4gbmV3IFByb21pc2U8aHR0cC5JbmNvbWluZ01lc3NhZ2U+KChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgIGNvbnN0IHJlcXVlc3RPYmogPSB0cmFuc3BvcnQucmVxdWVzdChvcHQsIChyZXNwb25zZSkgPT4ge1xyXG4gICAgICByZXNvbHZlKHJlc3BvbnNlKVxyXG4gICAgfSlcclxuXHJcbiAgICByZXF1ZXN0T2JqLm9uKCdlcnJvcicsIHJlamVjdClcclxuXHJcbiAgICBpZiAoIWJvZHkgfHwgQnVmZmVyLmlzQnVmZmVyKGJvZHkpIHx8IHR5cGVvZiBib2R5ID09PSAnc3RyaW5nJykge1xyXG4gICAgICByZXF1ZXN0T2JqLmVuZChib2R5KVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcGlwZWxpbmVBc3luYyhib2R5LCByZXF1ZXN0T2JqKS5jYXRjaChyZWplY3QpXHJcbiAgICB9XHJcbiAgfSlcclxufVxyXG5cclxuY29uc3QgTUFYX1JFVFJJRVMgPSAyXHJcbmNvbnN0IEVYUF9CQUNLX09GRl9CQVNFX0RFTEFZID0gMTAwMCAvLyBCYXNlIGRlbGF5IGZvciBleHBvbmVudGlhbCBiYWNrb2ZmXHJcbmNvbnN0IEFERElUSU9OQUxfREVMQVlfRkFDVE9SID0gMS4wIC8vIHRvIGF2b2lkIHN5bmNocm9uaXplZCByZXRyaWVzXHJcblxyXG4vLyBSZXRyeWFibGUgZXJyb3IgY29kZXMgZm9yIEhUVFAgKCByZWY6IG1pbmlvLWdvKVxyXG5leHBvcnQgY29uc3QgcmV0cnlIdHRwQ29kZXM6IFJlY29yZDxzdHJpbmcsIGJvb2xlYW4+ID0ge1xyXG4gIDQwODogdHJ1ZSxcclxuICA0Mjk6IHRydWUsXHJcbiAgNDk5OiB0cnVlLFxyXG4gIDUwMDogdHJ1ZSxcclxuICA1MDI6IHRydWUsXHJcbiAgNTAzOiB0cnVlLFxyXG4gIDUwNDogdHJ1ZSxcclxuICA1MjA6IHRydWUsXHJcbn1cclxuXHJcbmNvbnN0IGlzSHR0cFJldHJ5YWJsZSA9IChodHRwUmVzQ29kZTogbnVtYmVyKSA9PiB7XHJcbiAgcmV0dXJuIHJldHJ5SHR0cENvZGVzW2h0dHBSZXNDb2RlXSAhPT0gdW5kZWZpbmVkXHJcbn1cclxuXHJcbmNvbnN0IHNsZWVwID0gKG1zOiBudW1iZXIpID0+IHtcclxuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgbXMpKVxyXG59XHJcblxyXG5jb25zdCBnZXRFeHBCYWNrT2ZmRGVsYXkgPSAocmV0cnlDb3VudDogbnVtYmVyKSA9PiB7XHJcbiAgY29uc3QgYmFja09mZkJ5ID0gRVhQX0JBQ0tfT0ZGX0JBU0VfREVMQVkgKiAyICoqIHJldHJ5Q291bnRcclxuICBjb25zdCBhZGRpdGlvbmFsRGVsYXkgPSBNYXRoLnJhbmRvbSgpICogYmFja09mZkJ5ICogQURESVRJT05BTF9ERUxBWV9GQUNUT1JcclxuICByZXR1cm4gYmFja09mZkJ5ICsgYWRkaXRpb25hbERlbGF5XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZXF1ZXN0V2l0aFJldHJ5KFxyXG4gIHRyYW5zcG9ydDogVHJhbnNwb3J0LFxyXG4gIG9wdDogaHR0cHMuUmVxdWVzdE9wdGlvbnMsXHJcbiAgYm9keTogQnVmZmVyIHwgc3RyaW5nIHwgc3RyZWFtLlJlYWRhYmxlIHwgbnVsbCA9IG51bGwsXHJcbiAgbWF4UmV0cmllczogbnVtYmVyID0gTUFYX1JFVFJJRVMsXHJcbik6IFByb21pc2U8aHR0cC5JbmNvbWluZ01lc3NhZ2U+IHtcclxuICBsZXQgYXR0ZW1wdCA9IDBcclxuICBsZXQgaXNSZXRyeWFibGUgPSBmYWxzZVxyXG4gIHdoaWxlIChhdHRlbXB0IDw9IG1heFJldHJpZXMpIHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdCh0cmFuc3BvcnQsIG9wdCwgYm9keSlcclxuICAgICAgLy8gQ2hlY2sgaWYgdGhlIEhUVFAgc3RhdHVzIGNvZGUgaXMgcmV0cnlhYmxlXHJcbiAgICAgIGlmIChpc0h0dHBSZXRyeWFibGUocmVzcG9uc2Uuc3RhdHVzQ29kZSBhcyBudW1iZXIpKSB7XHJcbiAgICAgICAgaXNSZXRyeWFibGUgPSB0cnVlXHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBSZXRyeWFibGUgSFRUUCBzdGF0dXM6ICR7cmVzcG9uc2Uuc3RhdHVzQ29kZX1gKSAvLyB0cmlnZ2VyIHJldHJ5IGF0dGVtcHQgd2l0aCBjYWxjdWxhdGVkIGRlbGF5XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHJldHVybiByZXNwb25zZSAvLyBTdWNjZXNzLCByZXR1cm4gdGhlIHJhdyByZXNwb25zZVxyXG4gICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgIGlmIChpc1JldHJ5YWJsZSkge1xyXG4gICAgICAgIGF0dGVtcHQrK1xyXG4gICAgICAgIGlzUmV0cnlhYmxlID0gZmFsc2VcclxuXHJcbiAgICAgICAgaWYgKGF0dGVtcHQgPiBtYXhSZXRyaWVzKSB7XHJcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFJlcXVlc3QgZmFpbGVkIGFmdGVyICR7bWF4UmV0cmllc30gcmV0cmllczogJHtlcnJ9YClcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgZGVsYXkgPSBnZXRFeHBCYWNrT2ZmRGVsYXkoYXR0ZW1wdClcclxuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZVxyXG4gICAgICAgIGNvbnNvbGUud2FybihcclxuICAgICAgICAgIGAke25ldyBEYXRlKCkudG9Mb2NhbGVTdHJpbmcoKX0gUmV0cnlpbmcgcmVxdWVzdCAoYXR0ZW1wdCAke2F0dGVtcHR9LyR7bWF4UmV0cmllc30pIGFmdGVyICR7ZGVsYXl9bXMgZHVlIHRvOiAke2Vycn1gLFxyXG4gICAgICAgIClcclxuICAgICAgICBhd2FpdCBzbGVlcChkZWxheSlcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0aHJvdyBlcnIgLy8gcmUtdGhyb3cgaWYgYW55IHJlcXVlc3QsIHN5bnRheCBlcnJvcnNcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgdGhyb3cgbmV3IEVycm9yKGAke01BWF9SRVRSSUVTfSBSZXRyaWVzIGV4aGF1c3RlZCwgcmVxdWVzdCBmYWlsZWQuYClcclxufVxyXG4iXSwibWFwcGluZ3MiOiJBQUdBLFNBQVNBLFFBQVE7QUFDakIsU0FBU0MsU0FBUztBQUlsQixNQUFNQyxhQUFhLEdBQUdELFNBQVMsQ0FBQ0QsUUFBUSxDQUFDO0FBRXpDLE9BQU8sZUFBZUcsT0FBT0EsQ0FDM0JDLFNBQW9CLEVBQ3BCQyxHQUF5QixFQUN6QkMsSUFBOEMsR0FBRyxJQUFJLEVBQ3RCO0VBQy9CLE9BQU8sSUFBSUMsT0FBTyxDQUF1QixDQUFDQyxPQUFPLEVBQUVDLE1BQU0sS0FBSztJQUM1RCxNQUFNQyxVQUFVLEdBQUdOLFNBQVMsQ0FBQ0QsT0FBTyxDQUFDRSxHQUFHLEVBQUdNLFFBQVEsSUFBSztNQUN0REgsT0FBTyxDQUFDRyxRQUFRLENBQUM7SUFDbkIsQ0FBQyxDQUFDO0lBRUZELFVBQVUsQ0FBQ0UsRUFBRSxDQUFDLE9BQU8sRUFBRUgsTUFBTSxDQUFDO0lBRTlCLElBQUksQ0FBQ0gsSUFBSSxJQUFJTyxNQUFNLENBQUNDLFFBQVEsQ0FBQ1IsSUFBSSxDQUFDLElBQUksT0FBT0EsSUFBSSxLQUFLLFFBQVEsRUFBRTtNQUM5REksVUFBVSxDQUFDSyxHQUFHLENBQUNULElBQUksQ0FBQztJQUN0QixDQUFDLE1BQU07TUFDTEosYUFBYSxDQUFDSSxJQUFJLEVBQUVJLFVBQVUsQ0FBQyxDQUFDTSxLQUFLLENBQUNQLE1BQU0s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