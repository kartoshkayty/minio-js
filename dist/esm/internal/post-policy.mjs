// Build PostPolicy object that can be signed by presignedPostPolicy
import * as errors from "../errors.mjs";
import { isObject, isValidBucketName, isValidObjectName, isValidPrefix } from "./helper.mjs";
export class PostPolicy {
  policy = {
    conditions: []
  };
  formData = {};

  // set expiration date
  setExpires(date) {
    if (!date) {
      throw new errors.InvalidDateError('Invalid date: cannot be null');
    }
    this.policy.expiration = date.toISOString();
  }

  // set object name
  setKey(objectName) {
    if (!isValidObjectName(objectName)) {
      throw new errors.InvalidObjectNameError(`Invalid object name : ${objectName}`);
    }
    this.policy.conditions.push(['eq', '$key', objectName]);
    this.formData.key = objectName;
  }

  // set object name prefix, i.e policy allows any keys with this prefix
  setKeyStartsWith(prefix) {
    if (!isValidPrefix(prefix)) {
      throw new errors.InvalidPrefixError(`Invalid prefix : ${prefix}`);
    }
    this.policy.conditions.push(['starts-with', '$key', prefix]);
    this.formData.key = prefix;
  }

  // set bucket name
  setBucket(bucketName) {
    if (!isValidBucketName(bucketName)) {
      throw new errors.InvalidBucketNameError(`Invalid bucket name : ${bucketName}`);
    }
    this.policy.conditions.push(['eq', '$bucket', bucketName]);
    this.formData.bucket = bucketName;
  }

  // set Content-Type
  setContentType(type) {
    if (!type) {
      throw new Error('content-type cannot be null');
    }
    this.policy.conditions.push(['eq', '$Content-Type', type]);
    this.formData['Content-Type'] = type;
  }

  // set Content-Type prefix, i.e image/ allows any image
  setContentTypeStartsWith(prefix) {
    if (!prefix) {
      throw new Error('content-type cannot be null');
    }
    this.policy.conditions.push(['starts-with', '$Content-Type', prefix]);
    this.formData['Content-Type'] = prefix;
  }

  // set Content-Disposition
  setContentDisposition(value) {
    if (!value) {
      throw new Error('content-disposition cannot be null');
    }
    this.policy.conditions.push(['eq', '$Content-Disposition', value]);
    this.formData['Content-Disposition'] = value;
  }

  // set minimum/maximum length of what Content-Length can be.
  setContentLengthRange(min, max) {
    if (min > max) {
      throw new Error('min cannot be more than max');
    }
    if (min < 0) {
      throw new Error('min should be > 0');
    }
    if (max < 0) {
      throw new Error('max should be > 0');
    }
    this.policy.conditions.push(['content-length-range', min, max]);
  }

  // set user defined metadata
  setUserMetaData(metaData) {
    if (!isObject(metaData)) {
      throw new TypeError('metadata should be of type "object"');
    }
    Object.entries(metaData).forEach(([key, value]) => {
      const amzMetaDataKey = `x-amz-meta-${key}`;
      this.policy.conditions.push(['eq', `$${amzMetaDataKey}`, value]);
      this.formData[amzMetaDataKey] = value.toString();
    });
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJlcnJvcnMiLCJpc09iamVjdCIsImlzVmFsaWRCdWNrZXROYW1lIiwiaXNWYWxpZE9iamVjdE5hbWUiLCJpc1ZhbGlkUHJlZml4IiwiUG9zdFBvbGljeSIsInBvbGljeSIsImNvbmRpdGlvbnMiLCJmb3JtRGF0YSIsInNldEV4cGlyZXMiLCJkYXRlIiwiSW52YWxpZERhdGVFcnJvciIsImV4cGlyYXRpb24iLCJ0b0lTT1N0cmluZyIsInNldEtleSIsIm9iamVjdE5hbWUiLCJJbnZhbGlkT2JqZWN0TmFtZUVycm9yIiwicHVzaCIsImtleSIsInNldEtleVN0YXJ0c1dpdGgiLCJwcmVmaXgiLCJJbnZhbGlkUHJlZml4RXJyb3IiLCJzZXRCdWNrZXQiLCJidWNrZXROYW1lIiwiSW52YWxpZEJ1Y2tldE5hbWVFcnJvciIsImJ1Y2tldCIsInNldENvbnRlbnRUeXBlIiwidHlwZSIsIkVycm9yIiwic2V0Q29udGVudFR5cGVTdGFydHNXaXRoIiwic2V0Q29udGVudERpc3Bvc2l0aW9uIiwidmFsdWUiLCJzZXRDb250ZW50TGVuZ3RoUmFuZ2UiLCJtaW4iLCJtYXgiLCJzZXRVc2VyTWV0YURhdGEiLCJtZXRhRGF0YSIsIlR5cGVFcnJvciIsIk9iamVjdCIsImVudHJpZXMiLCJmb3JFYWNoIiwiYW16TWV0YURhdGFLZXkiLCJ0b1N0cmluZyJdLCJzb3VyY2VzIjpbInBvc3QtcG9saWN5LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIEJ1aWxkIFBvc3RQb2xpY3kgb2JqZWN0IHRoYXQgY2FuIGJlIHNpZ25lZCBieSBwcmVzaWduZWRQb3N0UG9saWN5XHJcbmltcG9ydCAqIGFzIGVycm9ycyBmcm9tICcuLi9lcnJvcnMudHMnXHJcbmltcG9ydCB7IGlzT2JqZWN0LCBpc1ZhbGlkQnVja2V0TmFtZSwgaXNWYWxpZE9iamVjdE5hbWUsIGlzVmFsaWRQcmVmaXggfSBmcm9tICcuL2hlbHBlci50cydcclxuaW1wb3J0IHR5cGUgeyBPYmplY3RNZXRhRGF0YSB9IGZyb20gJy4vdHlwZS50cydcclxuXHJcbmV4cG9ydCBjbGFzcyBQb3N0UG9saWN5IHtcclxuICBwdWJsaWMgcG9saWN5OiB7IGNvbmRpdGlvbnM6IChzdHJpbmcgfCBudW1iZXIpW11bXTsgZXhwaXJhdGlvbj86IHN0cmluZyB9ID0ge1xyXG4gICAgY29uZGl0aW9uczogW10sXHJcbiAgfVxyXG4gIHB1YmxpYyBmb3JtRGF0YTogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9XHJcblxyXG4gIC8vIHNldCBleHBpcmF0aW9uIGRhdGVcclxuICBzZXRFeHBpcmVzKGRhdGU6IERhdGUpIHtcclxuICAgIGlmICghZGF0ZSkge1xyXG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLkludmFsaWREYXRlRXJyb3IoJ0ludmFsaWQgZGF0ZTogY2Fubm90IGJlIG51bGwnKVxyXG4gICAgfVxyXG4gICAgdGhpcy5wb2xpY3kuZXhwaXJhdGlvbiA9IGRhdGUudG9JU09TdHJpbmcoKVxyXG4gIH1cclxuXHJcbiAgLy8gc2V0IG9iamVjdCBuYW1lXHJcbiAgc2V0S2V5KG9iamVjdE5hbWU6IHN0cmluZykge1xyXG4gICAgaWYgKCFpc1ZhbGlkT2JqZWN0TmFtZShvYmplY3ROYW1lKSkge1xyXG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLkludmFsaWRPYmplY3ROYW1lRXJyb3IoYEludmFsaWQgb2JqZWN0IG5hbWUgOiAke29iamVjdE5hbWV9YClcclxuICAgIH1cclxuICAgIHRoaXMucG9saWN5LmNvbmRpdGlvbnMucHVzaChbJ2VxJywgJyRrZXknLCBvYmplY3ROYW1lXSlcclxuICAgIHRoaXMuZm9ybURhdGEua2V5ID0gb2JqZWN0TmFtZVxyXG4gIH1cclxuXHJcbiAgLy8gc2V0IG9iamVjdCBuYW1lIHByZWZpeCwgaS5lIHBvbGljeSBhbGxvd3MgYW55IGtleXMgd2l0aCB0aGlzIHByZWZpeFxyXG4gIHNldEtleVN0YXJ0c1dpdGgocHJlZml4OiBzdHJpbmcpIHtcclxuICAgIGlmICghaXNWYWxpZFByZWZpeChwcmVmaXgpKSB7XHJcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZFByZWZpeEVycm9yKGBJbnZhbGlkIHByZWZpeCA6ICR7cHJlZml4fWApXHJcbiAgICB9XHJcbiAgICB0aGlzLnBvbGljeS5jb25kaXRpb25zLnB1c2goWydzdGFydHMtd2l0aCcsICcka2V5JywgcHJlZml4XSlcclxuICAgIHRoaXMuZm9ybURhdGEua2V5ID0gcHJlZml4XHJcbiAgfVxyXG5cclxuICAvLyBzZXQgYnVja2V0IG5hbWVcclxuICBzZXRCdWNrZXQoYnVja2V0TmFtZTogc3RyaW5nKSB7XHJcbiAgICBpZiAoIWlzVmFsaWRCdWNrZXROYW1lKGJ1Y2tldE5hbWUpKSB7XHJcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZEJ1Y2tldE5hbWVFcnJvcihgSW52YWxpZCBidWNrZXQgbmFtZSA6ICR7YnVja2V0TmFtZX1gKVxyXG4gICAgfVxyXG4gICAgdGhpcy5wb2xpY3kuY29uZGl0aW9ucy5wdXNoKFsnZXEnLCAnJGJ1Y2tldCcsIGJ1Y2tldE5hbWVdKVxyXG4gICAgdGhpcy5mb3JtRGF0YS5idWNrZXQgPSBidWNrZXROYW1lXHJcbiAgfVxyXG5cclxuICAvLyBzZXQgQ29udGVudC1UeXBlXHJcbiAgc2V0Q29udGVudFR5cGUodHlwZTogc3RyaW5nKSB7XHJcbiAgICBpZiAoIXR5cGUpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdjb250ZW50LXR5cGUgY2Fubm90IGJlIG51bGwnKVxyXG4gICAgfVxyXG4gICAgdGhpcy5wb2xpY3kuY29uZGl0aW9ucy5wdXNoKFsnZXEnLCAnJENvbnRlbnQtVHlwZScsIHR5cGVdKVxyXG4gICAgdGhpcy5mb3JtRGF0YVsnQ29udGVudC1UeXBlJ10gPSB0eXBlXHJcbiAgfVxyXG5cclxuICAvLyBzZXQgQ29udGVudC1UeXBlIHByZWZpeCwgaS5lIGltYWdlLyBhbGxvd3MgYW55IGltYWdlXHJcbiAgc2V0Q29udGVudFR5cGVTdGFydHNXaXRoKHByZWZpeDogc3RyaW5nKSB7XHJcbiAgICBpZiAoIXByZWZpeCkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2NvbnRlbnQtdHlwZSBjYW5ub3QgYmUgbnVsbCcpXHJcbiAgICB9XHJcbiAgICB0aGlzLnBvbGljeS5jb25kaXRpb25zLnB1c2goWydzdGFydHMtd2l0aCcsICckQ29udGVudC1UeXBlJywgcHJlZml4XSlcclxuICAgIHRoaXMuZm9ybURhdGFbJ0NvbnRlbnQtVHlwZSddID0gcHJlZml4XHJcbiAgfVxyXG5cclxuICAvLyBzZXQgQ29udGVudC1EaXNwb3NpdGlvblxyXG4gIHNldENvbnRlbnREaXNwb3NpdGlvbih2YWx1ZTogc3RyaW5nKSB7XHJcbiAgICBpZiAoIXZhbHVlKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignY29udGVudC1kaXNwb3NpdGlvbiBjYW5ub3QgYmUgbnVsbCcpXHJcbiAgICB9XHJcbiAgICB0aGlzLnBvbGljeS5jb25kaXRpb25zLnB1c2goWydlcScsICckQ29udGVudC1EaXNwb3NpdGlvbicsIHZhbHVlXSlcclxuICAgIHRoaXMuZm9ybURhdGFbJ0NvbnRlbnQtRGlzcG9zaXRpb24nXSA9IHZhbHVlXHJcbiAgfVxyXG5cclxuICAvLyBzZXQgbWluaW11bS9tYXhpbXVtIGxlbmd0aCBvZiB3aGF0IENvbnRlbnQtTGVuZ3RoIGNhbiBiZS5cclxuICBzZXRDb250ZW50TGVuZ3RoUmFuZ2UobWluOiBudW1iZXIsIG1heDogbnVtYmVyKSB7XHJcbiAgICBpZiAobWluID4gbWF4KSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignbWluIGNhbm5vdCBiZSBtb3JlIHRoYW4gbWF4JylcclxuICAgIH1cclxuICAgIGlmIChtaW4gPCAwKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignbWluIHNob3VsZCBiZSA+IDAnKVxyXG4gICAgfVxyXG4gICAgaWYgKG1heCA8IDApIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdtYXggc2hvdWxkIGJlID4gMCcpXHJcbiAgICB9XHJcbiAgICB0aGlzLnBvbGljeS5jb25kaXRpb25zLnB1c2goWydjb250ZW50LWxlbmd0aC1yYW5nZScsIG1pbiwgbWF4XSlcclxuICB9XHJcblxyXG4gIC8vIHNldCB1c2VyIGRlZmluZWQgbWV0YWRhdGFcclxuICBzZXRVc2VyTWV0YURhdGEobWV0YURhdGE6IE9iamVjdE1ldGFEYXRhKSB7XHJcbiAgICBpZiAoIWlzT2JqZWN0KG1ldGFEYXRhKSkge1xyXG4gICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdtZXRhZGF0YSBzaG91bGQgYmUgb2YgdHlwZSBcIm9iamVjdFwiJylcclxuICAgIH1cclxuICAgIE9iamVjdC5lbnRyaWVzKG1ldGFEYXRhKS5mb3JFYWNoKChba2V5LCB2YWx1ZV0pID0+IHtcclxuICAgICAgY29uc3QgYW16TWV0YURhdGFLZXkgPSBgeC1hbXotbWV0YS0ke2tleX1gXHJcbiAgICAgIHRoaXMucG9saWN5LmNvbmRpdGlvbnMucHVzaChbJ2VxJywgYCQke2Ftek1ldGFEYXRhS2V5fWAsIHZhbHVlXSlcclxuICAgICAgdGhpcy5mb3JtRGF0YVthbXpNZXRhRGF0YUtleV0gPSB2YWx1ZS50b1N0cmluZygpXHJcbiAgICB9KVxyXG4gIH1cclxufVxyXG4iXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0EsT0FBTyxLQUFLQSxNQUFNLE1BQU0sZUFBYztBQUN0QyxTQUFTQyxRQUFRLEVBQUVDLGlCQUFpQixFQUFFQyxpQkFBaUIsRUFBRUMsYUFBYSxRQUFRLGNBQWE7QUFHM0YsT0FBTyxNQUFNQyxVQUFVLENBQUM7RUFDZkMsTUFBTSxHQUErRDtJQUMxRUMsVUFBVSxFQUFFO0VBQ2QsQ0FBQztFQUNNQyxRQUFRLEdBQTJCLENBQUMsQ0FBQzs7RUFFNUM7RUFDQUMsVUFBVUEsQ0FBQ0MsSUFBVSxFQUFFO0lBQ3JCLElBQUksQ0FBQ0EsSUFBSSxFQUFFO01BQ1QsTUFBTSxJQUFJVixNQUFNLENBQUNXLGdCQUFnQixDQUFDLDhCQUE4QixDQUFDO0lBQ25FO0lBQ0EsSUFBSSxDQUFDTCxNQUFNLENBQUNNLFVBQVUsR0FBR0Ys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